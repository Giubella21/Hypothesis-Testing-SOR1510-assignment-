# Hypothesis Testing Section

# 1. Correlation tests
cor_test_ret_age <- cor.test(data$RETPLASMA, data$AGE)
cor_test_beta_fiber <- cor.test(data$BETAPLASMA, data$FIBER)
cor_test_ret_beta <- cor.test(data$RETPLASMA, data$BETAPLASMA)

print("Correlation between RETPLASMA and AGE:")
print(cor_test_ret_age)

print("Correlation between BETAPLASMA and FIBER:")
print(cor_test_beta_fiber)

print("Correlation between RETPLASMA and BETAPLASMA:")
print(cor_test_ret_beta)

# 2. T-tests for group differences
# Sex differences in plasma retinol
t_test_sex_ret <- t.test(RETPLASMA ~ SEX, data = data)
print("T-test for sex differences in plasma retinol:")
print(t_test_sex_ret)

# Sex differences in plasma beta-carotene
t_test_sex_beta <- t.test(BETAPLASMA ~ SEX, data = data)
print("T-test for sex differences in plasma beta-carotene:")
print(t_test_sex_beta)

# 3. ANOVA tests
# Smoking status and plasma retinol
anova_smoke_ret <- aov(RETPLASMA ~ SMOKSTAT, data = data)
print("ANOVA for smoking status and plasma retinol:")
print(summary(anova_smoke_ret))

# Vitamin use and plasma beta-carotene
anova_vituse_beta <- aov(BETAPLASMA ~ VITUSE, data = data)
print("ANOVA for vitamin use and plasma beta-carotene:")
print(summary(anova_vituse_beta))

# 4. Multiple Linear Regression for RETPLASMA
model_ret <- lm(RETPLASMA ~ AGE + SEX + QUETELET + ALCOHOL + SMOKSTAT, data = data)
print("Multiple regression for plasma retinol:")
print(summary(model_ret))

# Check regression assumptions
png("regression_diagnostics_ret.png", width = 800, height = 600)
par(mfrow = c(2, 2))
plot(model_ret)
dev.off()

# 5. Multiple Linear Regression for BETAPLASMA (log-transformed)
# Log transformation due to right skew
data$log_BETAPLASMA <- log(data$BETAPLASMA + 1)  # Add 1 to handle zeros

model_beta <- lm(log_BETAPLASMA ~ BETADIET + VITUSE + FIBER + QUETELET + 
                 CHOLESTEROL + AGE + SEX, data = data)
print("Multiple regression for log-transformed plasma beta-carotene:")
print(summary(model_beta))

# Check regression assumptions for beta-carotene model
png("regression_diagnostics_beta.png", width = 800, height = 600)
par(mfrow = c(2, 2))
plot(model_beta)
dev.off()

# 6. Model comparison and selection
# Reduced model for RETPLASMA
model_ret_reduced <- lm(RETPLASMA ~ AGE + SEX + QUETELET + ALCOHOL, data = data)
print("Reduced model for plasma retinol:")
print(summary(model_ret_reduced))

# Compare full vs reduced model
anova_comparison <- anova(model_ret_reduced, model_ret)
print("Comparison between full and reduced retinol models:")
print(anova_comparison)

# 7. Calculate R-squared values
rsquared_ret <- summary(model_ret)$r.squared
rsquared_beta <- summary(model_beta)$r.squared

cat("R-squared for retinol model:", round(rsquared_ret, 3), "\n")
cat("R-squared for beta-carotene model:", round(rsquared_beta, 3), "\n")

# 8. Create summary tables for report
# Extract coefficients for retinol model
ret_summary <- summary(model_ret)$coefficients
ret_table <- data.frame(
  Predictor = rownames(ret_summary),
  Coefficient = round(ret_summary[,1], 3),
  Std_Error = round(ret_summary[,2], 3),
  t_value = round(ret_summary[,3], 3),
  p_value = round(ret_summary[,4], 4)
)

# Extract coefficients for beta-carotene model
beta_summary <- summary(model_beta)$coefficients
beta_table <- data.frame(
  Predictor = rownames(beta_summary),
  Coefficient = round(beta_summary[,1], 3),
  Std_Error = round(beta_summary[,2], 3),
  t_value = round(beta_summary[,3], 3),
  p_value = round(beta_summary[,4], 4)
)

print("Retinol model coefficients:")
print(ret_table)

print("Beta-carotene model coefficients:")
print(beta_table)

# 9. Diagnostic plots
png("final_diagnostics.png", width = 1000, height = 800)
par(mfrow = c(3, 3))

# Residual plots for retinol model
plot(model_ret$fitted.values, model_ret$residuals, 
     main = "Retinol: Residuals vs Fitted",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
qqnorm(model_ret$residuals, main = "Retinol: Q-Q Plot")
qqline(model_ret$residuals, col = "red")
hist(model_ret$residuals, main = "Retinol: Residual Distribution",
     xlab = "Residuals", col = "lightblue")

# Residual plots for beta-carotene model
plot(model_beta$fitted.values, model_beta$residuals, 
     main = "Beta-Carotene: Residuals vs Fitted",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
qqnorm(model_beta$residuals, main = "Beta-Carotene: Q-Q Plot")
qqline(model_beta$residuals, col = "red")
hist(model_beta$residuals, main = "Beta-Carotene: Residual Distribution",
     xlab = "Residuals", col = "lightgreen")

# Observed vs Predicted plots
plot(data$RETPLASMA, model_ret$fitted.values,
     main = "Retinol: Observed vs Predicted",
     xlab = "Observed RETPLASMA", ylab = "Predicted RETPLASMA")
abline(0, 1, col = "red")
plot(exp(data$log_BETAPLASMA) - 1, exp(model_beta$fitted.values) - 1,
     main = "Beta-Carotene: Observed vs Predicted",
     xlab = "Observed BETAPLASMA", ylab = "Predicted BETAPLASMA")
abline(0, 1, col = "red")

dev.off()
